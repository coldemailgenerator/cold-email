
{% extends "layout.html" %}

{% block title %}Email Archive - Cold Email Generator{% endblock %}

{% block content %}
<div class="dashboard-header">
    <div class="container">
        <h1>
            <i class="fas fa-archive"></i>
            Email Archive
        </h1>
        <p>View and manage all your generated emails</p>
        <div style="margin-top: 2rem;">
            <a href="/generate" class="btn btn-primary" style="margin-right: 1rem;">
                <i class="fas fa-plus"></i>
                Generate New Email
            </a>
            <a href="/home" class="btn btn-secondary">
                <i class="fas fa-home"></i>
                Back to Dashboard
            </a>
        </div>
    </div>
</div>

<div class="container">
    {% if emails %}
        <div class="card" style="margin-bottom: 2rem;">
            <div class="card-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0;">
                        <i class="fas fa-envelope"></i>
                        Your Emails ({{ emails|length }})
                    </h3>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <select id="filterSelect" class="form-control" style="width: auto;">
                            <option value="">All Emails</option>
                            <option value="locked">Locked Only</option>
                            <option value="unlocked">Unlocked Only</option>
                        </select>
                        <select id="sortSelect" class="form-control" style="width: auto;">
                            <option value="newest">Newest First</option>
                            <option value="oldest">Oldest First</option>
                            <option value="subject">By Subject</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="emails-grid" id="emailsGrid">
            {% for email in emails %}
            <div class="email-card {% if email.is_locked %}locked{% endif %}" data-locked="{{ 'true' if email.is_locked else 'false' }}" data-date="{{ email.created_at.isoformat() }}" data-subject="{{ email.subject }}">
                {% if email.is_locked %}
                    <i class="fas fa-lock lock-icon"></i>
                {% endif %}
                
                <div class="email-header">
                    <div class="email-subject">{{ email.subject }}</div>
                    <div class="email-meta">
                        <span>
                            <i class="fas fa-palette"></i>
                            {{ email.tone.title() }}
                        </span>
                        <span>
                            <i class="fas fa-calendar"></i>
                            {{ email.created_at.strftime('%b %d, %Y') }}
                        </span>
                    </div>
                </div>
                
                <div class="email-body">
                    {% if email.is_locked %}
                        <div style="text-align: center; padding: 2rem;">
                            <i class="fas fa-lock" style="font-size: 3rem; color: var(--warning-color); margin-bottom: 1rem;"></i>
                            <p style="color: var(--text-muted); font-style: italic; margin-bottom: 1rem;">
                                This email is locked for privacy
                            </p>
                            <a href="/locked" class="btn btn-warning btn-sm">
                                <i class="fas fa-unlock"></i>
                                Unlock Email
                            </a>
                        </div>
                    {% else %}
                        <div style="max-height: 150px; overflow: hidden; position: relative;">
                            {{ email.content }}
                            <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 30px; background: linear-gradient(transparent, var(--card-bg));"></div>
                        </div>
                    {% endif %}
                </div>
                
                <div class="email-actions">
                    {% if not email.is_locked %}
                        <button onclick="copyEmail('{{ email.id }}')" class="btn btn-secondary btn-sm">
                            <i class="fas fa-copy"></i>
                            Copy
                        </button>
                        <button onclick="viewEmail('{{ email.id }}')" class="btn btn-primary btn-sm">
                            <i class="fas fa-eye"></i>
                            View Full
                        </button>
                    {% endif %}
                    <button onclick="deleteEmail('{{ email.id }}')" class="btn btn-danger btn-sm">
                        <i class="fas fa-trash"></i>
                        Delete
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="card">
            <div class="card-body" style="text-align: center; padding: 4rem;">
                <i class="fas fa-inbox" style="font-size: 4rem; color: var(--text-muted); margin-bottom: 2rem;"></i>
                <h3 style="color: var(--text-color); margin-bottom: 1rem;">No emails yet</h3>
                <p style="color: var(--text-light); margin-bottom: 2rem;">
                    You haven't generated any emails yet. Start creating your first cold email!
                </p>
                <a href="/generate" class="btn btn-primary">
                    <i class="fas fa-magic"></i>
                    Generate Your First Email
                </a>
            </div>
        </div>
    {% endif %}
</div>

<!-- Email Modal -->
<div id="emailModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; padding: 2rem;">
    <div style="background: var(--card-bg); border-radius: 15px; max-width: 600px; margin: 0 auto; max-height: 90vh; overflow-y: auto;">
        <div style="padding: 2rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0;">Email Details</h3>
            <button onclick="closeModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-color);">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="modalContent" style="padding: 2rem;">
            <!-- Email content will be loaded here -->
        </div>
    </div>
</div>

<script>
// Filter and sort functionality
document.getElementById('filterSelect').addEventListener('change', filterEmails);
document.getElementById('sortSelect').addEventListener('change', sortEmails);

function filterEmails() {
    const filter = document.getElementById('filterSelect').value;
    const cards = document.querySelectorAll('.email-card');
    
    cards.forEach(card => {
        const isLocked = card.dataset.locked === 'true';
        let show = true;
        
        if (filter === 'locked' && !isLocked) show = false;
        if (filter === 'unlocked' && isLocked) show = false;
        
        card.style.display = show ? 'block' : 'none';
    });
}

function sortEmails() {
    const sort = document.getElementById('sortSelect').value;
    const grid = document.getElementById('emailsGrid');
    const cards = Array.from(grid.children);
    
    cards.sort((a, b) => {
        if (sort === 'newest') {
            return new Date(b.dataset.date) - new Date(a.dataset.date);
        } else if (sort === 'oldest') {
            return new Date(a.dataset.date) - new Date(b.dataset.date);
        } else if (sort === 'subject') {
            return a.dataset.subject.localeCompare(b.dataset.subject);
        }
    });
    
    cards.forEach(card => grid.appendChild(card));
}

function copyEmail(emailId) {
    // Implement copy functionality
    fetch(`/api/email/${emailId}`)
        .then(response => response.json())
        .then(data => {
            navigator.clipboard.writeText(data.content);
            showToast('Email copied to clipboard!', 'success');
        });
}

function viewEmail(emailId) {
    // Load and show email in modal
    fetch(`/api/email/${emailId}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('modalContent').innerHTML = `
                <div class="email-header" style="margin-bottom: 1rem;">
                    <h4>${data.subject}</h4>
                    <div style="color: var(--text-light); font-size: 0.9rem;">
                        <span><i class="fas fa-palette"></i> ${data.tone}</span> â€¢ 
                        <span><i class="fas fa-calendar"></i> ${new Date(data.created_at).toLocaleDateString()}</span>
                    </div>
                </div>
                <div style="background: var(--bg-color); padding: 1.5rem; border-radius: 10px; white-space: pre-wrap;">
                    ${data.content}
                </div>
                <div style="margin-top: 1.5rem; text-align: center;">
                    <button onclick="copyEmail('${emailId}')" class="btn btn-primary">
                        <i class="fas fa-copy"></i> Copy Email
                    </button>
                </div>
            `;
            document.getElementById('emailModal').style.display = 'block';
        });
}

function closeModal() {
    document.getElementById('emailModal').style.display = 'none';
}

function deleteEmail(emailId) {
    if (confirm('Are you sure you want to delete this email?')) {
        fetch(`/api/email/${emailId}`, { method: 'DELETE' })
            .then(response => {
                if (response.ok) {
                    showToast('Email deleted successfully', 'success');
                    location.reload();
                } else {
                    showToast('Failed to delete email', 'error');
                }
            });
    }
}

// Close modal when clicking outside
document.getElementById('emailModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});
</script>
{% endblock %}
